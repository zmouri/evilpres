var b2Vec2=Box2D.Common.Math.b2Vec2,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2Fixture=Box2D.Dynamics.b2Fixture,b2World=Box2D.Dynamics.b2World,b2MassData=Box2D.Collision.Shapes.b2MassData,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw=Box2D.Dynamics.b2DebugDraw,b2MouseJointDef=Box2D.Dynamics.Joints.b2MouseJointDef,b2PrismaticJointDef=Box2D.Dynamics.Joints.b2PrismaticJointDef,b2ContactListener=Box2D.Dynamics.b2ContactListener;Crafty.c("Box2D",{body:null,fixtures:null,init:function(){this.requires("2D");if(!Crafty.box2D.world){Crafty.box2D.init(0,10,55,true)}},box2d:function(d){var b=Crafty.box2D.world;var f=Crafty.box2D.PTM_RATIO;var c;var a=0;this.fixtures=[];var e=new b2BodyDef;if(d.bodyType==="dynamic"){e.type=b2Body.b2_dynamicBody}else{if(d.bodyType==="static"){e.type=b2Body.b2_staticBody}else{e.type=b2Body.b2_kinematicBody}}e.position.Set(this._x/f,this._y/f);e.userData=this;this.body=b.CreateBody(e);this.addFixture(d);return this},addFixture:function(c){var e=Crafty.box2D.PTM_RATIO;if(c.fixDef){fixDef=obj.fixDef}else{fixDef=new b2FixtureDef;fixDef.density=(!isNaN(c.density))?c.density:1;fixDef.friction=(!isNaN(c.friction))?c.friction:0.5;fixDef.restitution=(!isNaN(c.restitution))?c.restitution:0.2;fixDef.shape=new b2PolygonShape;if(!c.shape||typeof c.shape==="string"){if(c.shape==="circle"){fixDef.shape=new b2CircleShape(this._w/e/2);fixDef.shape.SetLocalPosition(new b2Vec2(this._w/e/2,this._h/e/2))}else{vertexCount=2;fixDef.shape.SetAsOrientedBox(this._w/e/2,this._h/e/2,new b2Vec2(this._w/e/2,this._h/e/2))}}else{vertexCount=c.shape.length;var a=[];for(var d=0;d<vertexCount;d++){var b=c.shape[d];a.push(new b2Vec2(b[0]/e,b[1]/e))}fixDef.shape.SetAsArray(a,vertexCount)}this.fixtures.push(this.body.CreateFixture(fixDef));return this}},contact:function(d){var e=[];var c=Crafty(d);for(entity in c){if(!isNaN(entity)){var f=Crafty(c[entity]);if(!f.__c.Box2D){return false}else{for(_contact in Crafty.box2D.contacts){var b=Crafty.box2D.contacts[_contact];for(i in this.fixtures){var a=this.fixtures[i];for(j in f.fixtures){var g=f.fixtures[j];if((b.fixtureA===a&&b.fixtureB===g)||(b.fixtureA===g&&b.fixtureB===a)){e.push({obj:f,contact:b})}}}}}}}return(e.length)?e:false},onContact:function(a,b){this.bind("EnterFrame",function(){var c=this.contact(a);if(c){b.call(this,c)}});return this},});Crafty.extend({box2D:{ShowBox2DDebug:false,contacts:null,world:null,PTM_RATIO:null,init:function(f,d,b,h){var c=new b2World(new b2Vec2(f,d),h);var a=b;var e=[];var g=new b2ContactListener;g.BeginContact=function(k){var l={fixtureA:k.GetFixtureA(),fixtureB:k.GetFixtureB()};for(k in e){if((e[k].fixtureA==l.fixtureA)&&(e[k].fixtureB==l.fixtureB)){return}}e.push(l)};g.EndContact=function(k){var l={fixtureA:k.GetFixtureA(),fixtureB:k.GetFixtureB()};for(k in e){if((e[k].fixtureA==l.fixtureA)&&(e[k].fixtureB==l.fixtureB)){e.splice(k,1);return}}};c.SetContactListener(g);Crafty.bind("EnterFrame",function(){c.Step(1/30,8,3);for(var k=c.GetBodyList();k;k=k.GetNext()){if(k.GetUserData()){var l=k.GetUserData();l.attr({x:k.GetPosition().x*a,y:k.GetPosition().y*a});l.rotation=Crafty.math.radToDeg(k.GetAngle())}}if(Crafty.box2D.ShowBox2DDebug){c.DrawDebugData()}c.ClearForces()});Crafty.box2D.world=c;Crafty.box2D.PTM_RATIO=a;Crafty.box2D.contacts=e},showDebugInfo:function(){var b=Crafty.box2D.world;var a=Crafty.box2D.PTM_RATIO;if(Crafty.support.canvas){var e=document.createElement("canvas");e.id="Box2DCanvasDebug";e.width=Crafty.viewport.width;e.height=Crafty.viewport.height;e.style.position="absolute";e.style.left="0px";e.style.top="0px";Crafty.stage.elem.appendChild(e);var d=new b2DebugDraw();d.SetSprite(e.getContext("2d"));d.SetDrawScale(a);d.SetFillAlpha(0.7);d.SetLineThickness(1);d.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit);b.SetDebugDraw(d);Crafty.box2D.ShowBox2DDebug=true}else{Crafty.box2D.ShowBox2DDebug=false}}}});